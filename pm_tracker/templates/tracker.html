
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Cycle Planning & Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root { --slate-800: #1e293b; --slate-100: #f1f5f9; --blue-600: #2563eb; --green-500: #10b981; --amber-500: #f59e0b; --red-500: #ef4444; }
        body { background-color: var(--slate-100); color: #334155; font-family: 'Segoe UI', system-ui, sans-serif; }
        .kpi-card { background: white; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .funnel-step { position: relative; padding: 20px; text-align: center; background: white; border: 1px solid #e2e8f0; flex: 1; cursor: pointer; transition: background 0.2s; }
        .funnel-step:hover { background-color: #f8fafc; }
        .step-count { font-size: 2.5rem; font-weight: 700; display: block; margin-bottom: 0px; line-height: 1.2; }
        .step-pct { font-size: 0.9rem; color: #64748b; margin-bottom: 5px; display: block; font-weight: 500; }
        .step-label { text-transform: uppercase; font-size: 0.75rem; font-weight: 600; color: #64748b; }
        
        /* Status Colors */
        .text-no-et { color: var(--red-500); }
        .text-draft { color: #94a3b8; }
        .text-review { color: var(--amber-500); }
        .text-ready { color: var(--green-500); }

        .avatar-circle { width: 30px; height: 30px; background-color: #cbd5e1; color: #fff; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; margin-right: 8px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        .info-icon { font-size: 0.85rem; color: #cbd5e1; margin-left: 5px; cursor: help; }
        .pm-link { cursor: pointer; color: var(--blue-600); text-decoration: none; font-weight: 600; }
        .pm-link:hover { text-decoration: underline; }
        
        /* Badges */
        .badge-planning-closed { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .badge-planning-testing { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .badge-planning-open { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container-xl py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0 text-dark">Next Cycle Planning & Tracking</h4>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm active" id="btn-dashboard" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="btn btn-outline-secondary btn-sm" id="btn-settings" onclick="switchTab('settings')">Settings</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-secondary fw-medium" id="loading-msg">Loading...</p>
        </div>
    </div>

    <div id="error-alert" class="alert alert-danger shadow-sm border-0 hidden">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> <span id="error-msg"></span>
        <button class="btn-close float-end" onclick="document.getElementById('error-alert').classList.add('hidden')"></button>
    </div>

    <div id="tab-dashboard">
        
        <div id="config-warning" class="text-center py-5 hidden">
            <div class="alert alert-warning d-inline-block">
                Please configure <strong>Version IDs and API Keys</strong> in Settings.
            </div>
        </div>

        <div id="dashboard-content" class="hidden">
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="kpi-card p-3 h-100">
                        <h6 class="fw-bold text-uppercase text-secondary mb-3">PM Performance Matrix</h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>PM Owner</th>
                                        <th class="text-center text-danger">No ET</th>
                                        <th class="text-center text-muted">Draft ET</th>
                                        <th class="text-center text-warning">LD Review</th>
                                        <th class="text-center text-success">Ready</th>
                                        <th class="text-end border-start">Total</th>
                                        <th class="text-end">Total pt.</th>
                                    </tr>
                                </thead>
                                <tbody id="pm-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="fw-bold text-uppercase text-secondary mb-0">Pipeline</h6>
                        
                        <div class="d-flex align-items-center">
                            <label for="pm-filter" class="small fw-bold text-muted me-2">Filter by PM:</label>
                            <select id="pm-filter" class="form-select form-select-sm" style="width: 200px;" onchange="updateFunnel()">
                                <option value="All">All PMs</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-flex shadow-sm rounded-3 overflow-hidden">
                        <div class="funnel-step" onclick="showList('No ET')">
                            <span class="step-count text-no-et" id="count-no-et">0</span>
                            <span class="step-pct" id="pct-no-et">0%</span>
                            <span class="step-label">
                                1. No ET
                                <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-content="Stories with 0 estimated points."></i>
                            </span>
                        </div>
                        <div class="funnel-step" onclick="showList('Draft ET')">
                            <span class="step-count text-draft" id="count-draft">0</span>
                            <span class="step-pct" id="pct-draft">0%</span>
                            <span class="step-label">
                                2. Draft ET
                                <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-content="Points > 0, but not yet in Review or Ready."></i>
                            </span>
                        </div>
                        <div class="funnel-step" onclick="showList('LD Review')">
                            <span class="step-count text-review" id="count-review">0</span>
                            <span class="step-pct" id="pct-review">0%</span>
                            <span class="step-label">
                                3. LD Review
                                <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-content="Planning task is in 'Testing'."></i>
                            </span>
                        </div>
                        <div class="funnel-step" onclick="showList('Ready')">
                            <span class="step-count text-ready" id="count-ready">0</span>
                            <span class="step-pct" id="pct-ready">0%</span>
                            <span class="step-label">
                                4. Ready
                                <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-content="Status is explicitly 'Ready'."></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="list-section" class="mt-4 kpi-card p-3 hidden">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="fw-bold text-primary" id="list-title">Stories</h5>
                    <button class="btn btn-sm btn-close" onclick="closeList()"></button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Subject</th>
                                <th>PM</th>
                                <th>pt.</th>
                                <th>Status</th>
                                <th>SP Status</th>
                            </tr>
                        </thead>
                        <tbody id="list-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="hidden">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="kpi-card p-4">
                    <h5 class="fw-bold mb-3">Configuration</h5>
                    <form onsubmit="saveSettings(event)">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Redmine Base URL</label>
                            <input type="url" id="input-url" class="form-control" placeholder="https://redmine.example.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">API Key</label>
                            <input type="password" id="input-key" class="form-control" required>
                        </div>
                        <hr class="my-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-primary">C+1 (Next Cycle) Version ID</label>
                            <input type="text" id="input-c1" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2">Save & Reload</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let c1Stories = [];
    let currentListCategory = null; 
    
    const config = {
        url: localStorage.getItem('dor_url') || '',
        key: localStorage.getItem('dor_key') || '',
        c1: localStorage.getItem('dor_c1') || ''
    };

    document.addEventListener('DOMContentLoaded', () => {
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        [...popoverTriggerList].map(el => new bootstrap.Popover(el));

        // Fill inputs
        document.getElementById('input-url').value = config.url;
        document.getElementById('input-key').value = config.key;
        document.getElementById('input-c1').value = config.c1;

        if (config.c1 && config.key && config.url) {
            loadDashboard();
        } else {
            switchTab('settings');
            document.getElementById('config-warning').classList.remove('hidden');
        }
    });

    async function fetchIssues(params) {
        const url = new URL('/api/issues', window.location.origin);
        for (const key in params) url.searchParams.append(key, params[key]);
        
        const headers = {
            'X-Redmine-Url': config.url,
            'X-Redmine-Key': config.key
        };

        const response = await fetch(url, { headers });
        if (!response.ok) {
             const errText = await response.text();
             throw new Error(`Server Error: ${response.status} - ${errText}`);
        }
        return (await response.json()).issues;
    }

    function extractPM(description) {
        if (!description) return 'Unassigned';
        const match = description.match(/(?:PM|Owner):\s*@?([\w.-]+)/i);
        return (match && match[1]) ? match[1].replace(/[.,]$/, '') : 'Unassigned';
    }

    function categorizeStory(story, allIssues) {
        const planningTask = allIssues.find(t => {
            if (!t.subject.toLowerCase().includes('story planning')) return false;
            if (t.parent && t.parent.id === story.id) return true;
            if (story.relations) {
                const isBlocker = story.relations.some(r => 
                    r.relation_type === 'blocks' && r.issue_to_id === story.id && r.issue_id === t.id
                );
                if (isBlocker) return true;
            }
            return false;
        });

        const status = story.status.name.toLowerCase();
        const planningStatus = planningTask ? planningTask.status.name : 'Missing';
        const displayAssignee = (planningTask && planningTask.assigned_to) ? planningTask.assigned_to.name : '-';
        const points = story.estimated_hours || 0;

        if (status === 'ready') return { category: 'Ready', planningStatus };
        if (planningStatus.toLowerCase() === 'testing') return { category: 'LD Review', planningStatus };
        if (points === 0) return { category: 'No ET', planningStatus };
        return { category: 'Draft ET', planningStatus };
    }

    async function loadDashboard() {
        setLoading(true, "Fetching Open Stories...");
        try {
            const allIssues = await fetchIssues({ fixed_version_id: config.c1 });
            
            const filteredStories = [];
            allIssues.forEach(i => {
                const inVersion = i.fixed_version && String(i.fixed_version.id) === String(config.c1);
                if (!inVersion) return; 
                
                const s = i.subject.toLowerCase();
                if (s.includes('story planning') || s.includes('[&]') || s.includes('tech support')) return;
                
                filteredStories.push(i);
            });

            c1Stories = filteredStories.map(s => {
                const analysis = categorizeStory(s, allIssues);
                
                // PM Logic
                let pmName = extractPM(s.description);
                if (pmName === 'Unassigned' && s.subject.toLowerCase().includes('tech story')) {
                    pmName = 'Tech Story';
                }

                return {
                    ...s,
                    pm: pmName,
                    category: analysis.category,
                    planningStatus: analysis.planningStatus,
                    planningAssignee: analysis.planningAssignee
                };
            });

            populatePMSelector();
            updateFunnel();
            renderPMTable();

            document.getElementById('dashboard-content').classList.remove('hidden');
            document.getElementById('config-warning').classList.add('hidden');

        } catch (e) {
            showError(e.message);
        } finally {
            setLoading(false);
        }
    }

    function populatePMSelector() {
        const pmSet = new Set(c1Stories.map(s => s.pm));
        const pmList = Array.from(pmSet).sort();
        const select = document.getElementById('pm-filter');
        select.innerHTML = '<option value="All">All PMs</option>';
        pmList.forEach(pm => {
            const option = document.createElement('option');
            option.value = pm;
            option.textContent = pm;
            select.appendChild(option);
        });
    }

    function updateFunnel() {
        const selectedPM = document.getElementById('pm-filter').value;
        const activeStories = (selectedPM === 'All') 
            ? c1Stories 
            : c1Stories.filter(s => s.pm === selectedPM);
            
        const counts = { 'No ET': 0, 'Draft ET': 0, 'LD Review': 0, 'Ready': 0 };
        const totalItems = activeStories.length;

        activeStories.forEach(s => {
            if (counts[s.category] !== undefined) counts[s.category]++;
        });

        updateFunnelStep('no-et', counts['No ET'], totalItems);
        updateFunnelStep('draft', counts['Draft ET'], totalItems);
        updateFunnelStep('review', counts['LD Review'], totalItems);
        updateFunnelStep('ready', counts['Ready'], totalItems);

        // Update list if open
        if (currentListCategory) {
            showList(currentListCategory);
        }
    }

    function renderPMTable() {
        const pmStats = {};
        
        c1Stories.forEach(s => {
            const pm = s.pm;
            const points = s.estimated_hours || 0;
            
            if (!pmStats[pm]) pmStats[pm] = { no_et:0, draft:0, review:0, ready:0, total:0, total_points:0 };
            
            pmStats[pm].total++;
            pmStats[pm].total_points += points;

            if (s.category === 'No ET') pmStats[pm].no_et++;
            if (s.category === 'Draft ET') pmStats[pm].draft++;
            if (s.category === 'LD Review') pmStats[pm].review++;
            if (s.category === 'Ready') pmStats[pm].ready++;
        });

        const tbody = document.getElementById('pm-table-body');
        tbody.innerHTML = '';
        
        const sortedPMs = Object.keys(pmStats).sort();

        for (const pm of sortedPMs) {
            const stats = pmStats[pm];
            const initials = pm.substring(0,2).toUpperCase();
            const ptsDisplay = stats.total_points % 1 === 0 ? stats.total_points : stats.total_points.toFixed(1);

            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="avatar-circle">${initials}</span>
                            <a onclick="showPMStories('${pm}')" class="pm-link">${pm}</a>
                        </div>
                    </td>
                    <td class="text-center fw-bold text-danger">${stats.no_et}</td>
                    <td class="text-center fw-bold text-muted">${stats.draft}</td>
                    <td class="text-center fw-bold text-secondary">${stats.review}</td>
                    <td class="text-center fw-bold text-success">${stats.ready}</td>
                    <td class="text-end border-start fw-medium">${stats.total}</td>
                    <td class="text-end fw-bold text-dark">${ptsDisplay}</td>
                </tr>`;
        }
    }

    function updateFunnelStep(id, count, total) {
        document.getElementById(`count-${id}`).textContent = count;
        const pct = total > 0 ? Math.round((count / total) * 100) : 0;
        document.getElementById(`pct-${id}`).textContent = `${pct}%`;
    }

    function showList(category) {
        currentListCategory = category;
        
        const selectedPM = document.getElementById('pm-filter').value;
        document.getElementById('list-title').textContent = `${category} Stories (${selectedPM === 'All' ? 'All PMs' : selectedPM})`;
        
        let filtered = c1Stories.filter(s => s.category === category);
        if (selectedPM !== 'All') {
            filtered = filtered.filter(s => s.pm === selectedPM);
        }
        renderTable(filtered);
    }
    
    function closeList() {
        document.getElementById('list-section').classList.add('hidden');
        currentListCategory = null; 
    }

    function showPMStories(pmName) {
        const select = document.getElementById('pm-filter');
        select.value = pmName;
        updateFunnel();
        
        currentListCategory = null; 
        document.getElementById('list-title').textContent = `All Stories for ${pmName}`;
        let filtered = c1Stories.filter(s => s.pm === pmName);
        renderTable(filtered);
    }

    function renderTable(stories) {
        // Sorting: PM -> Status -> Points
        stories.sort((a, b) => {
            if (a.pm !== b.pm) return a.pm.localeCompare(b.pm);
            if (a.status.name !== b.status.name) return a.status.name.localeCompare(b.status.name);
            return (b.estimated_hours || 0) - (a.estimated_hours || 0);
        });

        const tbody = document.getElementById('list-table-body');
        tbody.innerHTML = '';
        
        if (stories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No stories found for this selection.</td></tr>';
        } else {
            stories.forEach(s => {
                let spBadge = 'badge-planning-open';
                const spLower = s.planningStatus.toLowerCase();
                if (spLower === 'closed') spBadge = 'badge-planning-closed';
                else if (spLower === 'testing') spBadge = 'badge-planning-testing';

                let stClass = 'bg-secondary';
                if (s.status.name.toLowerCase() === 'ready') stClass = 'bg-success';
                if (s.status.name.toLowerCase() === 'new') stClass = 'bg-primary';

                const pts = s.estimated_hours ? parseFloat(s.estimated_hours) : 0;
                const ptsDisplay = pts % 1 === 0 ? pts : pts.toFixed(1);

                const row = `
                    <tr>
                        <td><a href="${config.url}/issues/${s.id}" target="_blank" class="text-decoration-none fw-bold">${s.id}</a></td>
                        <td>${s.subject}</td>
                        <td><span class="badge bg-light text-dark border">${s.pm}</span></td>
                        <td>${ptsDisplay}</td>
                        <td><span class="badge ${stClass}">${s.status.name}</span></td>
                        <td><span class="badge ${spBadge}">${s.planningStatus}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        const listSection = document.getElementById('list-section');
        listSection.classList.remove('hidden');
        listSection.scrollIntoView({ behavior: 'smooth' });
    }

    function switchTab(tab) {
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-settings').classList.add('hidden');
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.getElementById('btn-dashboard').classList.remove('active');
        document.getElementById('btn-settings').classList.remove('active');
        document.getElementById(`btn-${tab}`).classList.add('active');
    }

    function saveSettings(e) {
        e.preventDefault();
        config.url = document.getElementById('input-url').value.replace(/\/$/, ""); 
        config.key = document.getElementById('input-key').value;
        config.c1 = document.getElementById('input-c1').value;
        
        localStorage.setItem('dor_url', config.url);
        localStorage.setItem('dor_key', config.key);
        localStorage.setItem('dor_c1', config.c1);
        
        switchTab('dashboard');
        loadDashboard();
    }

    function setLoading(isLoading, msg) {
        const el = document.getElementById('loading');
        if (isLoading) {
            document.getElementById('loading-msg').textContent = msg || 'Loading...';
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    }

    function showError(msg) {
        document.getElementById('error-msg').textContent = msg;
        document.getElementById('error-alert').classList.remove('hidden');
    }
</script>

</body>
</html>